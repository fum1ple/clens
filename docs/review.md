# clens 要件定義書レビュー

## 重大な問題（実装前に必ず解決すべき）

| # | セクション | 問題 | 改善提案 |
|---|-----------|------|----------|
| 1 | 6.3 型定義 / 11.3 セキュリティ | **パストラバーサル防止の実装方針が未定義。** API の `:path` パラメータは URL エンコードされた任意文字列を受け取るが、`../` や絶対パスによるディレクトリ脱出をどう防ぐかの具体的なロジック（`path.resolve()` + prefix チェック、ホワイトリスト方式等）が記述されていない。POST `/api/files` の `path` パラメータも同様に危険。 | パス正規化の具体的アルゴリズムを定義する。例: (1) `path.resolve(root, inputPath)` で絶対パスに変換、(2) 結果が `root` のプレフィックスで始まることを検証、(3) ファイル拡張子が `.md` であることを検証、(4) パスが対象パターン（`.claude/skills/**/SKILL.md`, `.claude/commands/*.md`, `CLAUDE.md`）にマッチすることを検証。各 API エンドポイントでの検証フローをシーケンス図で示す。 |
| 2 | 11.3 セキュリティ | **「対象ファイルに限定」の検証ロジックが曖昧。** 何をもって「対象ファイル」と判定するかの基準が不明確。パターンマッチの具体仕様（glob パターン? 正規表現? ホワイトリスト?）が未定義のため、実装者の解釈に依存してしまう。 | ファイルパスの許可ルールを明示的に定義する。例: `許可パターン: ["CLAUDE.md", ".claude/commands/*.md", ".claude/skills/**/SKILL.md"]`。新規作成 API については、作成先パスが上記パターンのいずれかに合致することを必須条件とする。パターンマッチに使うライブラリ（micromatch 等）も指定が望ましい。 |
| 3 | 2 / 12 | **US-7（アウトライン表示: Should）とセクション 12（将来の拡張候補）が矛盾。** US-7 で「CLAUDE.md のセクションをアウトラインとして見たい」を Should として要求している一方、セクション 12 では「CLAUDE.md のセクションごとのアウトライン表示・ジャンプ」を v2 以降の拡張候補として列挙している。初期リリースに含むのか否かが不明。 | どちらかに統一する。(A) US-7 を維持して初期リリースに含める場合、セクション 12 からアウトライン関連の記述を削除。(B) v2 に回す場合、US-7 の優先度を Won't（初期リリース外）に変更し、その旨を明記。 |
| 4 | 5.4 / 5.3 | **開発モードでの Vite dev server と Hono サーバーの連携方式が未定義。** `pnpm run dev` で「同時起動」とあるが、2 つのサーバーがどう連携するかの記述がない。フロントエンドからの API リクエストのプロキシ設定（Vite の `server.proxy`）、ポートの割り当て、HMR と SSE の共存方法が不明。 | `vite.config.ts` における `server.proxy` 設定の方針を追記する。例: Vite dev server がポート 5173 で起動し、`/api/*` へのリクエストを Hono サーバー（ポート 4567）にプロキシする構成を明示。また、concurrently / tsx --watch 等を用いた同時起動スクリプトの構成も定義する。 |
| 5 | 6.1 API 設計 | **API のエラーレスポンス形式が未定義。** 各エンドポイントの正常系レスポンスは定義されているが、エラー時の HTTP ステータスコード・レスポンスボディの形式が一切記述されていない。ファイル未検出（404）、パス不正（400/403）、サーバーエラー（500）等の異常系が実装者任せになっている。 | 共通エラーレスポンス形式を定義する。例: `{ error: { code: string, message: string } }`。各エンドポイントで発生しうるエラーケースと対応する HTTP ステータスを表形式で列挙する。最低限: 404（ファイル不存在）、400（不正パス・不正リクエスト）、403（許可パターン外のアクセス）、409（競合）、500（内部エラー）。 |
| 6 | 6.2 SSE | **SSE 接続のライフサイクル管理が未定義。** 接続切断時の再接続戦略、複数タブで開いた場合の挙動、接続数の上限、ハートビート（keepalive）の有無が記述されていない。SSE は HTTP/1.1 ではブラウザごとに同一オリジンで 6 接続の制限があるため、複数タブでの利用時に問題になりうる。 | SSE のライフサイクル仕様を追加する: (1) クライアント側の自動再接続間隔（EventSource のデフォルト挙動に任せるか、カスタムか）、(2) サーバー側のハートビートコメント送信間隔（例: 30 秒ごと）、(3) 複数タブ時の挙動方針（SharedWorker 等の検討、または「単一タブ推奨」の明記）。 |

## 改善推奨（品質向上のため対応が望ましい）

| # | セクション | 問題 | 改善提案 |
|---|-----------|------|----------|
| 1 | 11.4 パッケージサイズ | **npm パッケージサイズ 2MB 以下の目標が非現実的な可能性が高い。** CodeMirror 6 の基本構成で約 500KB（minified）、React 18 + ReactDOM で約 130KB、react-markdown + remark-gfm + rehype で約 200KB、Tailwind CSS の生成 CSS が加わる。これらの合算だけで 800KB を超え、Commander.js, chokidar, Hono, その他ユーティリティを含めると 2MB は厳しい。 | 現実的な目標値を再設定する。`npm pack` で実際にサイズを計測した上で目標を調整する（5MB 以下程度が現実的か）。あるいは、「unpacked size」ではなく「download size（gzip 後）」で 2MB 以下とするなど、計測基準を明確にする。 |
| 2 | 11.3 セキュリティ | **localhost バインドでも CSRF 的な攻撃に脆弱。** 悪意のある Web ページが `fetch('http://127.0.0.1:4567/api/files/.claude/commands/malicious.md', { method: 'PUT', body: ... })` を実行すると、ブラウザの Same-Origin Policy は異なるオリジンへの simple request（特定条件）を許可する。SSE エンドポイントへの接続も `EventSource` で可能。 | (1) CORS ヘッダーを明示的に設定し、許可するオリジンを `http://127.0.0.1:4567` のみに限定する。(2) PUT/POST/DELETE リクエストにカスタムヘッダー（例: `X-Clens-Client: true`）を必須とし、preflight を強制する。(3) セキュリティ方針としてこれらの対策をセクション 11.3 に追記する。 |
| 3 | 4.2 / 8 | **未保存変更の状態管理に関する仕様が不足。** エディタの「ダーティ状態」（未保存の変更あり）をどう管理・表示するかが未定義。ブラウザのタブ閉じ時の確認ダイアログ（`beforeunload`）、ファイル切り替え時の未保存確認の要否も不明。 | (1) ファイル名の横に変更インジケータ（例: ● マーク）を表示する仕様を追加。(2) ファイル切り替え時に未保存変更がある場合の確認ダイアログを定義。(3) ブラウザタブ閉じ / リロード時の `beforeunload` イベントでの確認を定義。 |
| 4 | 4.2 / UX | **キーボードショートカットの要件が未定義。** 開発者ツールとして、`Ctrl+S`（保存）、`Ctrl+Z`（Undo）等の基本的なキーボードショートカットへの期待は高い。CodeMirror 6 はデフォルトで基本的なエディタショートカットを提供するが、Save 操作はアプリ固有のため明示的な定義が必要。 | 最低限のショートカット一覧を定義する: `Ctrl+S` / `Cmd+S`（保存）、`Ctrl+Z` / `Cmd+Z`（Undo ※CodeMirror デフォルト）。また、ブラウザデフォルトの `Ctrl+S`（ページ保存）を抑制する必要がある点を明記。 |
| 5 | 8 動作フロー | **`.claude` ディレクトリや対象ファイルが一切存在しない場合の挙動が未定義。** 新規プロジェクトや未設定プロジェクトで `npx clens` を実行した場合、空のファイルツリーが表示されるのか、ガイダンスが表示されるのか不明。 | (1) 対象ファイルが 0 件の場合の画面表示を定義する（例: 「対象ファイルが見つかりません。+ New からスキルやコマンドを作成できます」等のガイダンス）。(2) `.claude` ディレクトリが存在しない場合、新規作成時に自動生成するかどうかを明記。 |
| 6 | 6.1 API 設計 | **`GET /api/files/:path` の `:path` が複数セグメントを含む場合の URL 設計が曖昧。** `.claude/skills/my-skill/SKILL.md` のようなパスをそのまま URL パスセグメントにすると、ルーティングが複雑になる。Express/Hono での `*` パラメータとの違い、URL エンコーディングの扱いが不明。 | パスの渡し方を明確に定義する。方式 A: ワイルドカードパラメータ `GET /api/files/*path` を使用。方式 B: クエリパラメータ `GET /api/files?path=.claude/skills/...` を使用。方式 C: Base64 エンコード。Hono の `c.req.param()` の挙動に基づいた推奨方式を決定する。 |
| 7 | 7.2 CLI | **ポートフォールバックの上限が未定義。** 「使用中の場合は +1 にフォールバック」とあるが、何回試行するか、上限ポートはいくらか、全て使用中の場合のエラーメッセージが定義されていない。 | フォールバックの最大試行回数を定義する（例: 最大 10 回、4567〜4576 の範囲で試行）。全ポートが使用中の場合のエラーメッセージとエラーコードも定義する。difit は同様のロジックを持っているため、参考にできる。 |
| 8 | 9.2 競合 | **「最後の書き込み勝ち」戦略の限界と、Save 時のサーバー側検証が未定義。** クライアントが `GET` で取得した後にサーバー上でファイルが変更された場合、PUT リクエストは何の検証もなく上書きするのか。`updatedAt` フィールドが GET レスポンスにあるが、PUT 時にこれを送り返して楽観的ロック的なチェックを行うかどうか不明。 | MVP であっても最低限の対策を定義する: PUT リクエスト時に `If-Unmodified-Since` ヘッダーまたは `updatedAt` パラメータを送信し、サーバー側で現在のファイルの `mtime` と比較。不一致の場合は 409 Conflict を返し、クライアント側で競合解決 UI を表示する。 |
| 9 | 5.2 技術スタック | **フロントエンドの状態管理方針が未定義。** 選択中のファイル、エディタの内容、ダーティ状態、SSE から受信した更新情報など、複数のステートが連携する設計になるが、状態管理のアプローチ（React Context, Zustand, Jotai 等）が記述されていない。 | 状態管理の方針を明記する。MVP の規模であれば React Context + useReducer で十分と思われるが、将来の拡張性を考慮して Zustand 等の軽量ライブラリを検討する余地もある。いずれにせよ、管理すべきグローバルステートの一覧を定義する。 |
| 10 | 全体 | **テスト戦略が技術スタック名（Vitest）の記載のみで、方針が不在。** 単体テストの対象範囲、E2E テストの有無と対象（Playwright 等）、テストカバレッジの目標、CI での実行方針が一切定義されていない。 | テスト戦略セクションを追加する: (1) 単体テスト: scanner, watcher, パスバリデーション等のサーバーロジックを重点的にテスト。(2) API テスト: 各 REST エンドポイントのリクエスト/レスポンス検証。(3) E2E テスト: Playwright で基本フロー（ファイル選択→編集→保存→プレビュー反映）を検証。(4) カバレッジ目標（例: サーバー層 80% 以上）。 |
| 11 | 5.2 技術スタック | **Tailwind CSS v4 の採用リスクが未評価。** v4 は 2025 年初頭にリリースされた比較的新しいメジャーバージョンであり、v3 からの設定方式の大幅変更（CSS-first configuration）、エコシステムの互換性（プラグイン対応状況）等のリスクがある。difit が v4 を使っているとはいえ、安定性の評価が必要。 | Tailwind CSS v4 を採用する理由と、v3 との差異による影響（設定方式の変更、プラグイン互換性）を簡潔に記載する。あるいは、安定性を優先して v3 を採用する選択肢も検討する。 |

## 軽微な指摘（対応は任意）

| # | セクション | 問題 | 改善提案 |
|---|-----------|------|----------|
| 1 | 1.2 / 1.4 | 「等」「など」の多用。セクション 1.4「Codex, Cursor, Windsurf **等**の他ツール」、1.2「Markdown **として**散在」は問題ないが、曖昧さの温床にならないよう意識すべき。 | 現時点では実害なし。ただし、機能仕様に「○○等」が出てきた場合は列挙を網羅的に書き切ること。 |
| 2 | 6.3 型定義 | `FileNode` の `description` フィールドの抽出ロジックが「SKILL.md の先頭行**等**から抽出」と曖昧。コマンドファイルの description はどこから取得するのか不明。 | description 抽出ルールを明確化する。例: (1) SKILL.md: 最初の `#` 見出しの直後の段落、(2) コマンド: ファイル先頭の `#` 見出しテキスト、(3) CLAUDE.md: 固定文字列「Project Settings」。 |
| 3 | 4.1 Explorer | **ファイル削除の UI 仕様が不足。** US-8 で「ファイルを削除できるようにしたい（Should）」とあるが、画面構成やフローに削除操作の UI（右クリックメニュー? ゴミ箱アイコン?）の記載がない。 | ファイル削除の UI パターンを定義する: Explorer のファイル項目に対するコンテキストメニュー、または各ファイルのホバー時に表示される削除アイコン。削除前の確認ダイアログも定義する。 |
| 4 | 5.3 ディレクトリ構成 | `src/server/types.ts` と `src/shared/types.ts` の両方が存在する。型定義が分散する可能性がある。 | 役割分担を明記する。`shared/types.ts`: フロントエンド・サーバー間で共有する型（API のリクエスト/レスポンス型、FileNode 等）。`server/types.ts`: サーバー内部でのみ使用する型（chokidar のイベント型等）。 |
| 5 | 11.1 パフォーマンス | 「エディタ入力からプレビュー反映まで 100ms 以内（デバウンス適用）」の計測基準が曖昧。デバウンス間隔が 100ms なのか、デバウンス後のレンダリングが 100ms 以内なのか不明。 | 計測基準を明確化する。例:「デバウンス間隔: 150ms。最後の入力から Markdown レンダリング完了まで 300ms 以内」のように分離して記述する。 |
| 6 | 7.1 CLI | `--host` オプションの存在意義と注意事項が不足。`0.0.0.0` を指定した場合、セキュリティリスク（LAN 内からのアクセス可能）が生じるが、その警告が定義されていない。 | `--host 0.0.0.0` 指定時に CLI が警告メッセージを表示する仕様を追加する。例:「Warning: Server is exposed to the network. Only use this in trusted environments.」 |
| 7 | 10.1 テンプレート | テンプレートの格納場所（`templates/` ディレクトリ）が `src/` 外にあるが、npm パッケージ同梱時のバンドル方法が不明。 | `package.json` の `files` フィールドに `templates/` を含める旨を明記するか、ビルド時に `dist/` にコピーする方針を記載する。 |
| 8 | 4.2 Split View | Split View のリサイズ可否が未定義。左右ペインの比率を変更できるのか、固定 50:50 なのかが不明。 | 初期比率（例: 50:50）とリサイズ可否を明記する。MVP では固定でも問題ないが、明示的に「固定」と書くことで実装者の迷いを排除する。 |
| 9 | 11.2 互換性 | Node.js >= 18.0.0 と記載されているが、Node.js 18 は 2025 年 4 月に EOL を迎えている。 | 最低バージョンを Node.js >= 20.0.0 に引き上げるか、「LTS バージョンをサポート」と記載する。 |
| 10 | 全体 | **グレースフルシャットダウンの仕様が未定義。** `Ctrl+C` 時に SSE 接続のクローズ、chokidar の停止、一時ファイルのクリーンアップ等を行う必要があるが、記述がない。 | CLI 終了時のクリーンアップ手順を簡潔に定義する: (1) SSE 接続を全てクローズ、(2) chokidar watcher を停止、(3) HTTP サーバーを停止、(4) プロセス終了。 |
| 11 | 13 参考 | difit の説明に「Express を Hono に置き換え」とあるが、Express → Hono への移行で影響を受けるミドルウェア（静的ファイル配信、エラーハンドリング等）の差異が言及されていない。 | Express と Hono の主要な API 差異（ミドルウェア構文、静的ファイル配信方法、エラーハンドリングパターン）を付録として簡潔に記載するか、実装時の注意点として参照リンクを追加する。 |

## 総合評価

**成熟度: 3 / 5（基本設計は整っているが、実装着手前に補完が必要）**

要件定義書として、プロダクトビジョン・ユーザーストーリー・技術アーキテクチャ・画面構成・API 設計が一通り網羅されており、プロジェクトの全体像を把握するには十分な情報量を持っている。difit という具体的な参考実装がある点も、実装時の不確実性を低減する好材料である。

一方で、以下の点が「実装着手可能」レベル（4〜5）に達していない主要因である:

### 最も優先的に改善すべき上位 3 点

1. **セキュリティ仕様の具体化（重大 #1, #2 / 改善 #2）:** パストラバーサル防止と対象ファイル限定の検証ロジックが「方針」レベルに留まっており、実装者がセキュアなコードを書くための具体的な指針がない。read-only の difit と異なり、clens はファイル書き込み・作成・削除を行うため、セキュリティ設計の不備は直接的なリスクとなる。CORS/CSRF 対策も含め、セキュリティセクションを大幅に強化すべき。

2. **異常系・エッジケースの定義不足（重大 #5, #6 / 改善 #3, #5, #8）:** API エラーレスポンス、SSE のライフサイクル、ファイル不在時の挙動、未保存変更の状態管理など、「正常に動作しないとき」の仕様が全体的に薄い。正常系を実装した後にこれらを後付けすると設計の一貫性が損なわれるため、実装前に定義すべき。

3. **用語・仕様の矛盾と曖昧性の解消（重大 #3, #4 / 改善 #6）:** US-7 と将来拡張候補の矛盾、開発モードの連携方式の未定義、API パスパラメータの設計方針の曖昧さは、実装開始直後に手戻りを発生させる可能性が高い。これらは比較的短時間で解消できるため、早期に対応すべき。
