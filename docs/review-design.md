# clens 基本設計書レビュー

対象ドキュメント: `docs/design.md`（基本設計書）
参照ドキュメント: `docs/requirements.md`（要件定義書）

---

## 1. 重大な問題（実装前に必ず解決すべき）

### 1-1. API パスパラメータ `:path` のエンコーディング未定義

- **セクション:** 5.1（REST API）
- **問題:** `/api/files/:path` の `:path` にはスラッシュを含む相対パス（例: `.claude/skills/my-skill/SKILL.md`）が入るが、URL パスパラメータとしてのエンコーディング方針が未定義。Hono のルーターはデフォルトで `/` をパスセグメントの区切りとして扱うため、`/api/files/.claude/skills/my-skill/SKILL.md` はマッチしない。
- **改善提案:** 以下のいずれかを明示する。
  - (A) ワイルドカードルート `/api/files/*` を使用し、残りのパス全体をキャプチャする
  - (B) `:path` を Base64 や `encodeURIComponent` でエンコードしてクエリパラメータ風に扱う
  - 推奨は (A)。Hono は `/api/files/*` で `c.req.param('0')` 等からパス全体を取得可能。設計書にルーティングパターンを明記すべき。

### 1-2. エラーハンドリング設計の欠如

- **セクション:** 全体（特に 5.1, 5.2, 9）
- **問題:** API エラーレスポンスの形式、HTTP ステータスコードの使い分け、ファイル I/O エラー時の挙動、SSE 接続断時の再接続戦略がいずれも未定義。実装者がエラー処理をすべて独自判断で書くことになり、フロントエンド・バックエンド間の整合性が崩れるリスクが高い。
- **改善提案:** 以下を追加する。
  - **API エラーレスポンス形式:** 例: `{ error: { code: string, message: string } }` を定義し、全エンドポイントで統一
  - **HTTP ステータスコード一覧:** 400（バリデーションエラー）、404（ファイル未発見）、409（既存ファイルとの衝突）、500（サーバー内部エラー）等
  - **ファイル I/O エラー:** permission denied, ENOENT, disk full 等のケース別対応方針
  - **SSE 再接続:** `EventSource` の自動再接続に依存するか、カスタムロジックを実装するか（推奨: `EventSource` 標準の自動再接続 + 接続状態の UI 表示）

### 1-3. パストラバーサル防止の具体的な実装設計がない

- **セクション:** 5.1（REST API）、対応する要件: `requirements.md` 8.3
- **問題:** 要件定義書ではセキュリティ要件として「ファイル操作は `--root` 内に制限」「対象ファイルはスキル / コマンド / CLAUDE.md に限定」と明記されているが、設計書にはこれを実現するための具体的な実装方針が一切ない。
- **改善提案:** 以下の設計を追加する。
  - **パスの正規化:** `path.resolve(rootDir, requestedPath)` → `resolvedPath.startsWith(rootDir)` のチェック
  - **許可パターンのホワイトリスト:** リクエストパスが以下のいずれかにマッチすることを検証するミドルウェア
    - `CLAUDE.md`
    - `.claude/skills/**/SKILL.md`
    - `.claude/commands/*.md`
  - **シンボリックリンクの扱い:** `fs.realpath()` で実パスを解決してからチェック
  - これらを Hono ミドルウェアとして実装し、全ファイル操作エンドポイントに適用する旨を記載

### 1-4. フロントエンド状態管理の設計がない

- **セクション:** 3（ディレクトリ構成）、8（画面挙動の詳細）
- **問題:** フロントエンドの状態管理アプローチが未定義。以下の状態が設計されていない。
  - 現在選択中のファイルパス
  - エディタのダーティ状態（未保存変更の有無）
  - エディタの内容（編集中テキスト）とディスク上の内容の区別
  - SSE 接続状態
  - API 呼び出しのローディング状態
  - ファイルツリーのデータ
- **改善提案:** アプリケーション全体の状態設計を追加する。
  - 状態管理手法の選定（React Context + useReducer、または Zustand 等の軽量ライブラリ）
  - 主要な状態の型定義（例: `AppState { selectedFile, editorContent, savedContent, isDirty, sseStatus, ... }`）
  - 状態遷移の主要パターン（ファイル選択時、編集時、保存時、外部変更受信時）

### 1-5. US-7（CLAUDE.md アウトライン表示）の設計が完全に欠落

- **セクション:** 全体
- **問題:** 要件定義書 US-7（Should 優先度）で定義された「CLAUDE.md のセクションをアウトラインとして見たい」に対応する設計が一切ない。API エンドポイント、見出し抽出ロジック、UI コンポーネント、Explorer 内での表示位置のいずれも未記載。
- **改善提案:** Should 優先度であるため、以下のいずれかで対処する。
  - (A) 設計を追加: セクション見出し (`##`) をパースして Explorer の CLAUDE.md ノード配下にツリー表示する設計を記載。見出しクリック時にエディタの該当行にスクロールする挙動を定義
  - (B) 明示的に先送り: 「US-7 はMVP のスコープ外とし、v2 以降で設計する」と設計書に明記し、要件定義書側の優先度注記と整合させる
  - いずれにせよ、現状の「記載なし」は不可

---

## 2. 改善推奨（品質向上のため対応が望ましい）

### 2-1. watcher → SSE の内部通信アーキテクチャが未設計

- **セクション:** 3（ディレクトリ構成）、6（動作フロー）、9（競合ハンドリング）
- **問題:** `watcher.ts` がファイル変更を検知してから `sse.ts` がクライアントにイベントを送信するまでの内部通信経路が未定義。`watcher.ts` と `sse.ts` は別ファイルだが、どう接続するのか不明。
- **改善提案:** 以下を設計に追加する。
  - Node.js `EventEmitter` を使い、watcher が `emit('file:changed', payload)` → SSE ルートが `on('file:changed', ...)` でリスンするパターン
  - 複数 SSE クライアント接続の管理方法（接続リストの保持、切断時のクリーンアップ）

### 2-2. `POST /api/files` の既存ファイル衝突時の挙動が未定義

- **セクション:** 5.1（REST API）
- **問題:** 新規ファイル作成 API で、指定されたパスに既にファイルが存在する場合の挙動が定義されていない。
- **改善提案:** `409 Conflict` を返す仕様を明記する。フロントエンドのダイアログ側で事前に `GET /api/files` のツリー情報から重複チェックも行う旨を記載する。

### 2-3. スキルのディレクトリ削除の挙動が曖昧

- **セクション:** 5.1（REST API）
- **問題:** `DELETE /api/files/:path` でスキルを削除する場合、スキルはディレクトリ（`SKILL.md` を含む）として存在する。SKILL.md だけを削除するのか、ディレクトリごと削除するのか不明。
- **改善提案:** スキルの場合は `SKILL.md` を含むディレクトリ全体を削除する旨を明記する。ただし、ディレクトリ内に SKILL.md 以外のファイルがある場合の挙動も定義すべき（例: 警告を出して削除中止、または強制削除）。

### 2-4. `PUT /api/files/:path` のレスポンスに更新タイムスタンプがない

- **セクション:** 5.1（REST API）
- **問題:** `PUT` のレスポンスが `{ success: boolean }` のみで、更新後のタイムスタンプを返さない。外部変更の競合検知（セクション 9）でタイムスタンプ比較を行う場合、保存後の最新タイムスタンプをクライアントが把握できない。
- **改善提案:** レスポンスを `{ success: boolean, updatedAt: string }` に変更する。将来的な楽観的ロック導入の基盤にもなる。

### 2-5. SSE `file:changed` イベントにファイル内容全体を含める設計の妥当性

- **セクション:** 5.2（SSE）
- **問題:** `file:changed` のペイロードに `content: string` が含まれる。CLAUDE.md 等の大きなファイルでは、外部エディタで保存するたびに全文が SSE で送信される。通常の CLAUDE.md でも数十 KB になりうる。
- **改善提案:** ペイロードから `content` を削除し、`{ path: string, updatedAt: string }` のみとする。クライアント側で必要に応じて `GET /api/files/:path` でコンテンツを取得する設計にすれば、帯域の無駄を抑えつつ、必要な場合（該当ファイルを開いている場合）のみ取得できる。

### 2-6. 開発モードのアーキテクチャが不十分

- **セクション:** 4（ビルドと配布）
- **問題:** 「Vite dev server（HMR）+ CLI サーバーを同時起動」とあるが、2つのサーバーの連携方法が未定義。Vite dev server と Hono API サーバーが別ポートで動く場合、CORS やプロキシ設定が必要になる。
- **改善提案:** 以下のいずれかの方式を明記する。
  - (A) Vite のプロキシ設定で API リクエストを Hono サーバーに転送する（`vite.config.ts` の `server.proxy`）
  - (B) Hono サーバーに Vite dev middleware を組み込む（`@hono/vite-dev-server` 等）
  - 推奨は (A)。difit が同様のアプローチを取っているか確認し、踏襲可能ならその旨を記載する。

### 2-7. ポートフォールバックの詳細が不足

- **セクション:** 7.2（ポートフォールバック）
- **問題:** 「+1 にフォールバック」とあるが、何回まで試行するか、上限ポートはどこか、すべて失敗した場合のエラーメッセージが未定義。
- **改善提案:** 最大試行回数（例: 10 回）を明記し、すべて失敗した場合はエラーメッセージを出力して終了する旨を記載する。

### 2-8. CodeMirror 6 の React 統合方式が未指定

- **セクション:** 2（技術スタック）、3（ディレクトリ構成）
- **問題:** CodeMirror 6 は React ラッパーライブラリ（`@uiw/react-codemirror` 等）を使うか、`useRef` + `useEffect` で直接統合するかで実装が大きく異なる。この選択がコンポーネント設計に影響する。
- **改善提案:** 統合方式を明記する。`@uiw/react-codemirror` は簡便だが依存が増える。軽量さを重視するなら直接統合を選択し、`Editor.tsx` のインターフェース（props: `value`, `onChange`, `extensions` 等）を設計書に記載する。

---

## 3. 軽微な指摘（対応は任意）

### 3-1. `{ success: boolean }` レスポンスパターンの冗長性

- **セクション:** 5.1（REST API）
- **問題:** `PUT` と `DELETE` のレスポンスが `{ success: boolean }` だが、HTTP ステータスコード（200/204）が既に成功を示すため、`success` フィールドは冗長。`success: false` を返すケースがあるなら、それは HTTP 4xx/5xx で表現すべき。
- **改善提案:** 成功時は `204 No Content`（ボディなし）または `200` + 更新後のリソース情報を返す設計に変更する。

### 3-2. React 18 の選定理由

- **セクション:** 2（技術スタック）
- **問題:** 選定理由が「difit と同パターン」だが、React 19 が既にリリース済み。新規プロジェクトで旧バージョンを選択する積極的理由があるか。
- **改善提案:** React 19 が利用可能であることを認識した上で、18 を選択する理由（例: エコシステムの安定性、CodeMirror ラッパーの互換性）を明記するか、19 に更新する。

### 3-3. chokidar のバージョンが未指定

- **セクション:** 2（技術スタック）
- **問題:** chokidar は v3 と v4 で API が大きく異なる（v4 は ESM-only、API 変更あり）。バージョン未指定は実装時の混乱の元になる。
- **改善提案:** 使用バージョン（v3 or v4）を明記する。Node.js >= 20 の要件なら v4 (ESM) も選択肢だが、CommonJS 互換が必要なら v3 を指定する。

### 3-4. Tailwind CSS v4 の「difit と同一」は不正確な可能性

- **セクション:** 2（技術スタック）
- **問題:** difit が Tailwind CSS v3 を使用している場合、「difit と同一」という選定理由が不正確になる。v4 は CSS-first 設定、新エンジン等の破壊的変更があり、v3 とは別物。
- **改善提案:** difit が実際に使用しているバージョンを確認し、選定理由を正確に記述する。v4 を選ぶならその理由（パフォーマンス向上、モダンな設定方式等）を独立して記載する。

### 3-5. 本番モードでのフロントエンド静的配信の具体手段が未記載

- **セクション:** 4（ビルドと配布）、6（動作フロー: 「ビルド済みフロントエンドを静的配信」）
- **問題:** Hono でビルド済みフロントエンドを配信する具体的なミドルウェア（`@hono/node-server/serve-static` 等）が未記載。
- **改善提案:** 使用するミドルウェアと `dist/` ディレクトリのマウントパスを一行追記する。

### 3-6. グレースフルシャットダウンの設計がない

- **セクション:** 6（動作フロー）
- **問題:** SIGINT/SIGTERM 受信時のサーバー停止手順が未定義。chokidar の watcher クローズ、SSE 接続のクリーンアップ、ポート解放の順序が不明。
- **改善提案:** シャットダウンフローを追記する（watcher.close() → SSE 接続を閉じる → サーバー停止）。

### 3-7. テンプレート内容例が Basic Skill のみ

- **セクション:** 10（テンプレート内容例）
- **問題:** 5 種類のテンプレートのうち Basic Skill の例しか記載されていない。他のテンプレートの構造が不明。
- **改善提案:** 全テンプレートの内容を記載するか、少なくともコマンド系テンプレート（`basic-command`）の例を 1 つ追加して、スキルとコマンドの構造の違いを示す。

---

## 総合評価

**成熟度: 3 / 5（主要な設計欠落があり、補完が必要）**

### 評価の根拠

全体的なアーキテクチャの方向性は明確で、技術スタックの選定も概ね妥当。ディレクトリ構成、API エンドポイント一覧、動作フロー、競合ハンドリングの基本方針など、設計のアウトラインは揃っている。要件定義書との分離も適切に行われており、Note リンクの参照先もすべて存在する。

一方で、「どう実現するか」を記述する設計書としては、実装者が独自判断せざるを得ない領域が多い。特にエラーハンドリング、セキュリティ実装、フロントエンド状態管理、API パスパラメータのエンコーディングといった、実装の根幹に関わる設計が欠落している点は、開発着手前に解決すべき問題である。

### 最も優先的に改善すべき上位 3 点

| 順位 | 指摘 # | 概要 | 理由 |
|------|--------|------|------|
| 1 | 1-2 | エラーハンドリング設計の追加 | API エラー形式が未定義のままでは、フロントエンド・バックエンドの並行開発が困難。最初に合意すべき契約（contract）に相当する |
| 2 | 1-3 | パストラバーサル防止の実装設計 | セキュリティ要件の実装方針が「要件にある」だけで設計に落ちていない。ローカルツールとはいえ、任意ファイルアクセスの脆弱性は深刻 |
| 3 | 1-1 | API パスパラメータのエンコーディング定義 | REST API の最も基本的なルーティングが未定義であり、全ファイル操作エンドポイントに影響する。実装初日に決まっていないと手戻りが発生する |
