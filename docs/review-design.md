# clens 基本設計書レビュー

対象ドキュメント: `docs/design.md`（基本設計書）
参照ドキュメント: `docs/requirements.md`（要件定義書）

---

## 1. 重大な問題（実装前に必ず解決すべき）

### 1-1. API パスパラメータ `:path` のルーティング方式が未定義

- **セクション:** 5.1（REST API）
- **問題:** `/api/files/:path` の `:path` にはスラッシュを含む相対パス（例: `.claude/skills/my-skill/SKILL.md`）が入る。Hono のルーターはデフォルトで `/` をパスセグメントの区切りとして扱うため、このパターンではマッチしない。API の根幹となるルーティング方式が決まっていない。
- **改善提案:** ワイルドカードルート（`/api/files/*`）またはクエリパラメータ方式のいずれを採用するかを明記する。

### 1-2. US-7（CLAUDE.md アウトライン表示）の設計が完全に欠落

- **セクション:** 全体
- **問題:** 要件定義書 US-7（Should）で定義された「CLAUDE.md のセクションをアウトラインとして見たい」に対応する設計が一切ない。API エンドポイント、Explorer 上の表示位置など、アーキテクチャレベルの記載がない。
- **改善提案:** 以下のいずれかで対処する。
  - (A) 設計を追加する（API・コンポーネント構成を記載）
  - (B) 「US-7 は MVP スコープ外とし v2 以降で設計する」と設計書に明記し、要件定義書と整合させる
  - 現状の「記載なし」は不可。スコープ判断を明示すべき。

### 1-3. セキュリティ要件に対する設計方針がない

- **セクション:** 5.1（REST API）、対応する要件: `requirements.md` 8.3
- **問題:** 要件定義書では「ファイル操作は `--root` 内に制限」「対象ファイルはスキル / コマンド / CLAUDE.md に限定」と明記されている。しかし設計書には、これらの制約をアーキテクチャのどの層でどう実現するかの方針がない。
- **改善提案:** 以下の方針レベルの記述を追加する。
  - パスの検証をどの層で行うか（API ルートごとの個別チェック / 共通ミドルウェア）
  - 許可するパスパターンのホワイトリスト方式を採用するか否か

### 1-4. API のエラーレスポンス方針がない

- **セクション:** 5.1（REST API）
- **問題:** 正常系のレスポンス型は定義されているが、エラー時のレスポンス形式が未定義。フロントエンドとバックエンドの並行開発において、エラーレスポンスの契約が決まっていないと、両者の実装が噛み合わなくなるリスクがある。
- **改善提案:** API 契約として、エラーレスポンスの共通形式（例: `{ error: string, message: string }`）を型定義セクション（5.3）に追加する。個別エンドポイントごとのステータスコード詳細は詳細設計で定義すればよい。

---

## 2. 改善推奨（品質向上のため対応が望ましい）

### 2-1. watcher → SSE のモジュール間通信方式が未設計

- **セクション:** 3（ディレクトリ構成）、6（動作フロー）
- **問題:** `watcher.ts` と `sse.ts` は別モジュールだが、ファイル変更検知からクライアントへの SSE 送信までの接続方式が未定義。複数クライアント接続時の配信方式も不明。
- **改善提案:** モジュール間の依存方向と通信パターン（EventEmitter / コールバック / Pub-Sub 等）を設計書に明記する。

### 2-2. `POST /api/files` の既存ファイル衝突時の挙動が未定義

- **セクション:** 5.1（REST API）
- **問題:** 新規ファイル作成で、指定パスに既にファイルが存在する場合の挙動が API 契約として定義されていない。
- **改善提案:** 衝突時はエラーを返す旨を明記する。

### 2-3. スキル削除時の対象範囲が曖昧

- **セクション:** 5.1（REST API）
- **問題:** `DELETE /api/files/:path` でスキルを削除する場合、スキルはディレクトリ（`SKILL.md` を含む）として存在する。SKILL.md だけを削除するのか、ディレクトリごと削除するのかが不明。
- **改善提案:** スキルの削除対象（ファイルのみ / ディレクトリごと）を明記する。

### 2-4. SSE `file:changed` のペイロードにファイル内容全体を含める設計

- **セクション:** 5.2（SSE）
- **問題:** `file:changed` のペイロードに `content: string` が含まれている。ファイルサイズが大きい場合、外部エディタで保存するたびに全文が SSE で送信される。現在開いていないファイルの変更でも全文を受け取ることになる。
- **改善提案:** ペイロードを `{ path: string }` のみとし、クライアントが必要に応じて `GET /api/files/:path` で取得する方式を検討する。

### 2-5. 開発モードの2サーバー連携方式が未定義

- **セクション:** 4（ビルドと配布）
- **問題:** 「Vite dev server + CLI サーバーを同時起動」とあるが、2 つのサーバーの連携方式が未定義。別ポートで動く場合、API リクエストの転送方式（Vite プロキシ等）を決めておく必要がある。
- **改善提案:** Vite プロキシ方式か、Hono への Vite dev middleware 組み込み方式かを明記する。

### 2-6. `PUT /api/files/:path` のレスポンスに更新タイムスタンプがない

- **セクション:** 5.1（REST API）
- **問題:** `GET` は `updatedAt` を返すが、`PUT` のレスポンスには含まれない。保存後にクライアントが最新のタイムスタンプを把握できないと、外部変更との競合検知（セクション 9）が正しく機能しない可能性がある。
- **改善提案:** `PUT` のレスポンスにも `updatedAt` を含める。

### 2-7. フロントエンドの状態管理方針が未記載

- **セクション:** 3（ディレクトリ構成）
- **問題:** コンポーネント構成と hooks は定義されているが、アプリケーション全体の状態管理アプローチ（React Context / 軽量ライブラリ等）が未記載。セクション 8・9 で定義された画面挙動（ダーティ状態、外部変更検知時の分岐）はすべて状態管理に依存するため、方針が必要。
- **改善提案:** 技術スタックまたはディレクトリ構成のセクションに、状態管理の方針を追記する。

---

## 3. 軽微な指摘（対応は任意）

### 3-1. `{ success: boolean }` レスポンスパターンの冗長性

- **セクション:** 5.1（REST API）
- **問題:** `PUT` / `DELETE` のレスポンスが `{ success: boolean }` だが、HTTP ステータスコードで成功/失敗は表現されるため冗長。
- **改善提案:** `204 No Content` または更新後のリソース情報を返す設計に変更を検討する。

### 3-2. React 18 の選定理由

- **セクション:** 2（技術スタック）
- **問題:** 選定理由が「difit と同パターン」だが、React 19 がリリース済み。新規プロジェクトで旧バージョンを採用する理由が不明確。
- **改善提案:** 18 を選ぶ理由を明記するか、19 への更新を検討する。

### 3-3. chokidar のメジャーバージョンが未指定

- **セクション:** 2（技術スタック）
- **問題:** chokidar は v3 と v4 で API が大きく異なる（v4 は ESM-only）。バージョン未指定は実装時の混乱の元になる。
- **改善提案:** 使用するメジャーバージョンを明記する。

### 3-4. Tailwind CSS v4 の「difit と同一」は不正確の可能性

- **セクション:** 2（技術スタック）
- **問題:** difit が Tailwind CSS v3 を使用している場合、「difit と同一」が不正確。v4 は CSS-first 設定・新エンジン等の破壊的変更があり v3 とは別物。
- **改善提案:** difit の実際のバージョンを確認し、選定理由を正確に記述する。

### 3-5. テンプレート内容例が Basic Skill のみ

- **セクション:** 10（テンプレート内容例）
- **問題:** 5 種類のテンプレートのうち 1 つしか例示がなく、特にコマンド系テンプレートの構造が不明。
- **改善提案:** コマンド系テンプレートの例を 1 つ追加し、スキルとの構造の違いを示す。

---

## 総合評価

**成熟度: 3.5 / 5（方向性は明確だが、API 契約とセキュリティ方針の補完が必要）**

### 評価の根拠

アーキテクチャの方向性、技術スタック選定、ディレクトリ構成、動作フローなど、基本設計の骨格は十分に揃っている。要件定義書との分離も適切で、Note リンクの参照先もすべて存在する。

一方で、API ルーティングの基本方式、セキュリティ制約の実現方針、エラーレスポンスの契約など、フロントエンド・バックエンド間のインターフェース定義に不足がある。これらは基本設計として決めておくべき事項であり、詳細設計に入る前に解消すべきである。

### 最も優先的に改善すべき上位 3 点

| 順位 | 指摘 # | 概要 | 理由 |
|------|--------|------|------|
| 1 | 1-1 | API パスパラメータのルーティング方式 | 全ファイル操作エンドポイントに影響する基本的な API 契約が未定義 |
| 2 | 1-3 | セキュリティ制約の実現方針 | 要件定義書に明記されたセキュリティ要件を、設計のどの層で担保するかが決まっていない |
| 3 | 1-4 | エラーレスポンスの共通形式 | フロントエンド・バックエンド間の契約として、正常系だけでなくエラー系の形式も合意が必要 |
