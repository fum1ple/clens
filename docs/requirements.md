# clens 要件定義書

## 1. プロジェクト概要

### 1.1 背景

Claude Code や Codex などの AI コーディングエージェントの普及に伴い、Skill（`SKILL.md`）やカスタムコマンド（`.claude/commands/*.md`）、プロジェクト設定（`CLAUDE.md`）といった定義ファイルを作成・管理する機会が増えている。しかし、これらのファイルは Markdown として散在しており、一覧性がなく、プレビューしながら編集する手段も存在しない。

### 1.2 解決する課題

- プロジェクト内にどんなスキル / コマンドが定義されているか俯瞰できない
- Markdown の整形表示（レンダリング）をリアルタイムで確認しながら編集できない
- 新規スキル / コマンドを作るたびにフォーマットを手動で組み立てる必要がある

### 1.3 プロダクトビジョン

**clens**（Claude + lens）は、Claude Code のスキル・コマンド・プロジェクト設定ファイルを可視化し、プレビューしながら編集できるローカル Web サーバー型 CLI ツールである。

### 1.4 スコープ

- **対象ツール:** Claude Code（初期リリース）
- **対象外:** Codex, Cursor, Windsurf 等の他ツール（将来の拡張候補）

---

## 2. ユーザーストーリー

| # | ストーリー | 優先度 |
|---|-----------|--------|
| US-1 | 開発者として、`npx clens` を実行するだけでブラウザが開き、プロジェクト内のスキル・コマンド・CLAUDE.md を一覧で見たい | **Must** |
| US-2 | 開発者として、ファイルツリーからファイルを選択し、左にエディタ・右にプレビューの split view で編集したい | **Must** |
| US-3 | 開発者として、エディタで編集した内容がリアルタイムでプレビューに反映されてほしい | **Must** |
| US-4 | 開発者として、保存ボタンを押すと実ファイルに書き戻されてほしい | **Must** |
| US-5 | 開発者として、外部エディタ（VS Code 等）でファイルを変更したとき、ブラウザ側にも変更が自動反映されてほしい | **Must** |
| US-6 | 開発者として、テンプレートを選んで新しいスキルやコマンドをすぐに作りたい | **Must** |
| US-7 | 開発者として、CLAUDE.md のセクションをアウトラインとして見たい | **Should** |
| US-8 | 開発者として、ファイルを削除できるようにしたい | **Should** |

---

## 3. 対象ファイル

### 3.1 検出対象

| 種類 | パス | 形式 | ツリー上の分類 |
|------|------|------|---------------|
| スキル | `.claude/skills/**/SKILL.md` | ディレクトリ + SKILL.md | 📂 Skills |
| カスタムコマンド | `.claude/commands/*.md` | 単体 Markdown | 📂 Commands |
| プロジェクト設定 | `CLAUDE.md`（プロジェクトルート） | 単体 Markdown | 📄 CLAUDE.md（最上位に独立表示） |

### 3.2 CLAUDE.md の扱い

- ツリー上ではスキル / コマンドとは別枠で最上位に独立表示する
- 編集・プレビューは同じ split view を使用する
- テンプレートの対象外とする（プロジェクト固有のため）
- セクション単位のアウトライン表示を提供する（Should: Must 機能を優先し、余裕があれば実装）

---

## 4. 画面構成

```
┌──────────────────────────────────────────────────────────┐
│  clens                                [+ New] [Settings] │
├─────────────┬────────────────────────────────────────────┤
│  📁 Explorer │                                            │
│             │   ┌── Editor ────────┬── Preview ────────┐ │
│  📄 CLAUDE.md│   │                  │                    │ │
│             │   │  # Skill Name    │  Skill Name        │ │
│  📂 Skills   │   │  Description...  │  Description...    │ │
│   ├ skill-a │   │                  │  (rendered MD)     │ │
│   └ skill-b │   │                  │                    │ │
│             │   │                  │                    │ │
│  📂 Commands │   └──────────────────┴────────────────────┘ │
│   ├ cmd-1   │                                            │
│   └ cmd-2   │                           [Save] [Revert] │
└─────────────┴────────────────────────────────────────────┘
```

### 4.1 左ペイン — Explorer

- ファイルツリー形式でスキル / コマンド / CLAUDE.md をカテゴリ分けして表示
- 各ファイルをクリックで選択 → 右の split view に表示
- カテゴリはデフォルトで展開状態
- 「+ New」ボタンからテンプレート選択ダイアログを起動
- ファイル項目の右クリックでコンテキストメニューを表示し「削除」を実行可能（Should: US-8 に対応）

### 4.2 右ペイン — Split View

- **左半分（Editor）:** Markdown エディタ。シンタックスハイライト付き
- **右半分（Preview）:** リアルタイム Markdown レンダリング（GFM 対応）
- エディタへの入力がリアルタイムでプレビューに反映される
- Save ボタンまたはキーボードショートカット（Ctrl+S / Cmd+S）で実ファイルへ書き戻し
- Revert ボタンでディスク上のファイル内容に戻す
- Editor と Preview の分割比率は 50:50 固定（リサイズ不可）

> **Note:** 未保存変更時のファイル切り替え確認、ブラウザ離脱時の確認、削除時の確認ダイアログの詳細な挙動は基本設計書（`design.md`）セクション 8 を参照。

### 4.3 新規作成ダイアログ

- テンプレート一覧から選択
- ファイル名（スキル名 / コマンド名）を入力
- 作成先パスのプレビュー表示
- 作成後、自動的にエディタで開く

### 4.4 空状態（Empty State）

- 対象ファイルが一件も検出されなかった場合、右ペインにガイダンスを表示する
  - 「+ New」ボタンからスキルやコマンドを作成できる旨を案内する
  - CLAUDE.md が存在しない場合もその旨を表示する
- `.claude` ディレクトリが存在しない場合、新規作成時にサーバー側で自動生成する

---

## 5. CLI インターフェース

### 5.1 CLI オプション

| フラグ | デフォルト | 説明 |
|--------|-----------|------|
| `--port` | `4567` | サーバーのポート番号 |
| `--root` | `.`（カレントディレクトリ） | 対象プロジェクトのルートディレクトリ |
| `--no-open` | `false` | ブラウザの自動起動を抑制 |
| `--host` | `127.0.0.1` | バインドするホストアドレス |

> **Note:** コマンド例やポートフォールバック挙動の詳細は基本設計書（`design.md`）セクション 7 を参照。

---

## 6. 外部変更の競合ハンドリング

### 6.1 基本方針

MVP では「最後の書き込み勝ち」方式を採用する。ただし、ユーザーが未保存の編集中に外部変更が発生した場合は警告を表示する。

> **Note:** 競合検知時の具体的なフローは基本設計書（`design.md`）セクション 9 を参照。

---

## 7. 組み込みテンプレート

### 7.1 テンプレート一覧

| ID | テンプレート名 | カテゴリ | 説明 |
|----|---------------|----------|------|
| `basic-skill` | Basic Skill | skill | 最小限の SKILL.md 雛形 |
| `code-generation-skill` | Code Generation Skill | skill | コード生成系スキルの雛形 |
| `file-operation-skill` | File Operation Skill | skill | ファイル操作系スキルの雛形 |
| `basic-command` | Basic Command | command | コマンドの基本雛形 |
| `command-with-args` | Command with Arguments | command | 引数付きコマンドの雛形 |

> **Note:** テンプレートの具体的な内容例は基本設計書（`design.md`）セクション 10 を参照。

---

## 8. 非機能要件

### 8.1 パフォーマンス

- `npx` での初回起動（ダウンロード含む）が 10 秒以内
- サーバー起動からブラウザ表示まで 2 秒以内
- エディタ入力に対するプレビュー反映遅延: 100ms 以下
- 外部ファイル変更から SSE 通知まで 500ms 以内

### 8.2 互換性

- Node.js >= 20.0.0
- 対応 OS: macOS, Linux, Windows (WSL 含む)
- 対応ブラウザ: Chrome, Firefox, Safari, Edge（最新版）

### 8.3 セキュリティ

- サーバーはデフォルトで `127.0.0.1` にバインド（外部アクセス不可）
- ファイル操作は `--root` で指定されたディレクトリ内に制限（パストラバーサル防止）
- 対象ファイルはスキル / コマンド / CLAUDE.md に限定（任意ファイルの読み書き不可）

### 8.4 パッケージサイズ

- `npm pack` 出力の gzip 済みサイズを計測基準とする
- 具体的な上限値はプロトタイプ実装後の実測に基づいて設定する
- 不要な依存の同梱を避け、production dependencies を最小限に保つ

---

## 9. 将来の拡張候補（v2 以降）

以下は初期リリースのスコープ外とし、将来のバージョンで検討する。

- 他ツール対応（Codex の `AGENTS.md`, Cursor の `.cursor/rules/` 等）のプラグイン機構
- スキル間の依存関係・参照関係のグラフ表示
- Git diff との連携（変更点の可視化）
- ユーザー定義テンプレートの登録・管理
- バリデーション機能（必須フィールドの欠落、フォーマット不正の検出）
- CLI サブコマンド（`clens init skill my-skill` 等）
